<div class="grid gap-4" role="list">
  {% for file in files %}
  <article role="listitem" class="border border-slate-700 rounded-xl bg-slate-800/50 p-5 shadow-sm">
    <header class="flex flex-wrap items-center justify-between gap-3">
      <h3 class="text-lg font-semibold">{{ file.display_name if file.display_name else file.name }}</h3>
      <span class="text-xs font-mono text-slate-400">{{ file.status|capitalize }}</span>
    </header>
    <div class="mt-3">
      <div class="w-full bg-slate-900/60 rounded-full h-2" aria-hidden="true">
        <div class="h-2 rounded-full bg-emerald-400 transition-all" style="width: {{ file.progress }}%"></div>
      </div>
      <p class="sr-only">Progress {{ file.progress }} percent</p>
    </div>
    {% if file.status in ['queued', 'processing'] %}
    <form method="post" hx-post="/api/cancel/{{ request_id }}/{{ file.name }}" hx-swap="none" hx-on::afterRequest="htmx.ajax('GET', '/partials/status/{{ request_id }}', {target: '#status-area'})" class="mt-3">
      <button type="submit" class="inline-flex items-center gap-2 rounded border border-rose-400 px-4 py-2 text-xs font-semibold text-rose-200 hover:bg-rose-500/10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-rose-400">Cancel</button>
    </form>
    {% endif %}
    {% if file.error %}
    <p class="mt-3 text-sm text-rose-300">{{ file.error }}</p>
    {% endif %}
    {% if file.status == 'finished' %}
    <div class="mt-4 flex flex-wrap gap-3">
      <a href="/api/download/{{ request_id }}/{{ file.name }}.html" class="inline-flex items-center gap-2 rounded bg-emerald-500 px-4 py-2 text-xs font-semibold text-slate-900 hover:bg-emerald-400 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-300">Download HTML</a>
      <a href="/api/download/{{ request_id }}/{{ file.name }}.json" class="inline-flex items-center gap-2 rounded border border-emerald-400 px-4 py-2 text-xs font-semibold text-emerald-200 hover:bg-emerald-500/10 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-emerald-300">Download JSON</a>
      <details class="w-full mt-3 bg-slate-900/60 border border-slate-700 rounded-lg p-4">
        <summary class="cursor-pointer text-sm font-medium text-emerald-200 focus-visible:outline focus-visible:outline-2 focus-visible:outline-emerald-300">View tables inline</summary>
        <div class="mt-3 prose prose-invert max-w-none text-sm" hx-get="/api/download/{{ request_id }}/{{ file.name }}.html" hx-trigger="revealed" hx-target="this" hx-swap="outerHTML">
          <p class="text-xs text-slate-400">Loading previewâ€¦</p>
        </div>
      </details>
    </div>
    {% endif %}
    {% if file.status == 'cancelled' %}
    <p class="mt-3 text-sm text-slate-400">Processing stopped by user.</p>
    {% endif %}
  </article>
  {% else %}
  <p class="text-sm text-slate-300">No files registered for this request.</p>
  {% endfor %}
  {% if files and files|selectattr('status', 'in', ['finished', 'error', 'cancelled'])|list|length == files|length %}
  <div class="text-sm text-emerald-300">All files processed. You may close this tab.</div>
  {% endif %}
</div>
